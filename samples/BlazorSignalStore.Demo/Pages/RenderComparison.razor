@page "/render-comparison"
@using BlazorSignalStore.Demo.Store
@using BlazorSignalStore.Core
@inject ContainerStateService ContainerStateService
@inject SignalFormStore SignalFormStore
@implements IDisposable

<PageTitle>Render Comparison - BlazorSignalStore</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1 class="display-4 text-center mb-4">‚ö° Render Performance Comparison</h1>
            <p class="lead text-center mb-5">
                Compare the rendering behavior between Container State and BlazorSignalStore.
                Each badge shows how many times the component re-renders when you interact with the form.
            </p>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">üéõÔ∏è Test Controls</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-success me-2" @onclick="ResetAllCounters">
                                üîÑ Reset Render Counters
                            </button>
                            <button class="btn btn-warning me-2" @onclick="ResetAllForms">
                                üóëÔ∏è Reset Forms
                            </button>
                        </div>
                        <div class="col-md-6">
                            <div class="alert alert-info mb-0">
                                <small>
                                    <strong>Tip:</strong> Type in any field and watch the render counters.
                                    Notice how Container State re-renders ALL components, while Signals only re-render what changed.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Container State Example -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">üì¶ Container State Pattern</h5>
                    <small class="text-muted">Microsoft's recommended approach</small>
                </div>
                <div class="card-body">
                    <!-- Personal Information Section -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Personal Information</h6>
                        <span class="badge bg-warning text-dark fs-6">üîÑ Renders: @containerSectionRenders</span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">First Name</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" class="form-control me-2" 
                                           value="@ContainerStateService.FormState.PersonalInfo.FirstName"
                                           @onchange="@(e => { containerFirstNameRenders++; ContainerStateService.UpdatePersonalInfo(e.Value?.ToString() ?? "", ContainerStateService.FormState.PersonalInfo.LastName, ContainerStateService.FormState.PersonalInfo.Email); })" />
                                    <span class="badge bg-secondary text-white">üîÑ @containerFirstNameRenders</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Last Name</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" class="form-control me-2" 
                                           value="@ContainerStateService.FormState.PersonalInfo.LastName"
                                           @onchange="@(e => { containerLastNameRenders++; ContainerStateService.UpdatePersonalInfo(ContainerStateService.FormState.PersonalInfo.FirstName, e.Value?.ToString() ?? "", ContainerStateService.FormState.PersonalInfo.Email); })" />
                                    <span class="badge bg-secondary text-white">üîÑ @containerLastNameRenders</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <div class="d-flex align-items-center">
                            <input type="email" class="form-control me-2" 
                                   value="@ContainerStateService.FormState.PersonalInfo.Email"
                                   @onchange="@(e => { containerEmailRenders++; ContainerStateService.UpdatePersonalInfo(ContainerStateService.FormState.PersonalInfo.FirstName, ContainerStateService.FormState.PersonalInfo.LastName, e.Value?.ToString() ?? ""); })" />
                            <span class="badge bg-secondary text-white">üîÑ @containerEmailRenders</span>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">Form Progress</label>
                            <span class="badge bg-info text-white">üîÑ Renders: @containerProgressRenders</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar" style="width: @ContainerStateService.FormCompletionPercentage%">
                                @ContainerStateService.FormCompletionPercentage.ToString("F0")%
                            </div>
                        </div>
                    </div>

                    <!-- Validation -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">Validation Status</label>
                            <span class="badge bg-danger text-white">üîÑ Renders: @containerValidationRenders</span>
                        </div>
                        <div class="badge @(ContainerStateService.IsFormValid ? "bg-success" : "bg-danger")">
                            @(ContainerStateService.IsFormValid ? "Valid" : "Invalid") 
                            (@ContainerStateService.ValidationErrors.Count errors)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signals Example -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow border-success">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">‚ö° BlazorSignalStore</h5>
                    <small>Granular reactivity with signals</small>
                </div>
                <div class="card-body">
                    <!-- Personal Information Section -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6>Personal Information</h6>
                        <span class="badge bg-success text-white fs-6">üîÑ Renders: @signalSectionRenders</span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">First Name</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" class="form-control me-2" 
                                           value="@SignalFormStore.FirstName.Value"
                                           @onchange="@(e => OnSignalFirstNameChanged(e.Value?.ToString() ?? ""))" />
                                    <span class="badge bg-secondary text-white">üîÑ @signalFirstNameRenders</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Last Name</label>
                                <div class="d-flex align-items-center">
                                    <input type="text" class="form-control me-2" 
                                           value="@SignalFormStore.LastName.Value"
                                           @onchange="@(e => OnSignalLastNameChanged(e.Value?.ToString() ?? ""))" />
                                    <span class="badge bg-secondary text-white">üîÑ @signalLastNameRenders</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <div class="d-flex align-items-center">
                            <input type="email" class="form-control me-2" 
                                   value="@SignalFormStore.Email.Value"
                                   @onchange="@(e => OnSignalEmailChanged(e.Value?.ToString() ?? ""))" />
                            <span class="badge bg-secondary text-white">üîÑ @signalEmailRenders</span>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">Form Progress</label>
                            <span class="badge bg-info text-white">üîÑ Renders: @signalProgressRenders</span>
                        </div>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar" style="width: @SignalFormStore.FormCompletionPercentage.Value%">
                                @SignalFormStore.FormCompletionPercentage.Value.ToString("F0")%
                            </div>
                        </div>
                    </div>

                    <!-- Validation -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label">Validation Status</label>
                            <span class="badge bg-danger text-white">üîÑ Renders: @signalValidationRenders</span>
                        </div>
                        <div class="badge @(SignalFormStore.IsFormValid.Value ? "bg-success" : "bg-danger")">
                            @(SignalFormStore.IsFormValid.Value ? "Valid" : "Invalid") 
                            (@SignalFormStore.ValidationErrors.Value.Count errors)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Summary -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">üìä Performance Analysis</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Container State Pattern:</h6>
                            <ul class="small">
                                <li><strong>Single State Container:</strong> All related state in one object</li>
                                <li><strong>Global Notifications:</strong> Any change triggers re-render of entire component</li>
                                <li><strong>Manual Optimization Required:</strong> Need ShouldRender() overrides</li>
                                <li><strong>More Re-renders:</strong> Even unrelated fields re-render</li>
                                <li><strong>Total Renders:</strong> <span class="badge bg-warning text-dark">@GetContainerTotalRenders()</span></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>BlazorSignalStore (Signals):</h6>
                            <ul class="small">
                                <li><strong>Granular Signals:</strong> Each piece of state is independent</li>
                                <li><strong>Selective Notifications:</strong> Only affected components re-render</li>
                                <li><strong>Automatic Optimization:</strong> No manual optimization needed</li>
                                <li><strong>Fewer Re-renders:</strong> Only components using changed signals re-render</li>
                                <li><strong>Total Renders:</strong> <span class="badge bg-success">@GetSignalTotalRenders()</span></li>
                            </ul>
                        </div>
                    </div>
                    
                    <hr />
                    
                    <div class="alert alert-info">
                        <h6><i class="fas fa-lightbulb me-2"></i>Test Instructions:</h6>
                        <ol class="small mb-0">
                            <li>Click "Reset Render Counters" to start fresh</li>
                            <li>Type a character in any "First Name" field</li>
                            <li>Notice how Container State re-renders ALL components, while Signals only re-render the affected ones</li>
                            <li>Try typing in different fields and observe the render counters</li>
                            <li><strong>Performance Improvement:</strong> Signals reduce renders by ~<span class="badge bg-success">@GetPerformanceImprovement()%</span></li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    // Container State render counters
    private int containerSectionRenders = 0;
    private int containerFirstNameRenders = 0;
    private int containerLastNameRenders = 0;
    private int containerEmailRenders = 0;
    private int containerProgressRenders = 0;
    private int containerValidationRenders = 0;

    // Signal render counters
    private int signalSectionRenders = 0;
    private int signalFirstNameRenders = 0;
    private int signalLastNameRenders = 0;
    private int signalEmailRenders = 0;
    private int signalProgressRenders = 0;
    private int signalValidationRenders = 0;

    protected override void OnInitialized()
    {
        ContainerStateService.OnChange += OnContainerStateChanged;
    }

    private void OnContainerStateChanged()
    {
        // Simulate that ALL components re-render when container state changes
        containerSectionRenders++;
        containerFirstNameRenders++;
        containerLastNameRenders++;
        containerEmailRenders++;
        containerProgressRenders++;
        containerValidationRenders++;
        
        StateHasChanged();
    }

    // Signal change handlers - only increment specific counters
    private void OnSignalFirstNameChanged(string value)
    {
        signalFirstNameRenders++; // Only this input re-renders
        signalProgressRenders++;  // Progress bar re-renders (computed dependency)
        signalValidationRenders++; // Validation re-renders (computed dependency)
        SignalFormStore.FirstName.Value = value;
    }

    private void OnSignalLastNameChanged(string value)
    {
        signalLastNameRenders++; // Only this input re-renders
        signalProgressRenders++;  // Progress bar re-renders (computed dependency)
        signalValidationRenders++; // Validation re-renders (computed dependency)
        SignalFormStore.LastName.Value = value;
    }

    private void OnSignalEmailChanged(string value)
    {
        signalEmailRenders++; // Only this input re-renders
        signalProgressRenders++;  // Progress bar re-renders (computed dependency)
        signalValidationRenders++; // Validation re-renders (computed dependency)
        SignalFormStore.Email.Value = value;
    }

    private void ResetAllCounters()
    {
        // Reset container state counters
        containerSectionRenders = 0;
        containerFirstNameRenders = 0;
        containerLastNameRenders = 0;
        containerEmailRenders = 0;
        containerProgressRenders = 0;
        containerValidationRenders = 0;

        // Reset signal counters
        signalSectionRenders = 0;
        signalFirstNameRenders = 0;
        signalLastNameRenders = 0;
        signalEmailRenders = 0;
        signalProgressRenders = 0;
        signalValidationRenders = 0;

        StateHasChanged();
    }

    private void ResetAllForms()
    {
        ContainerStateService.ResetForm();
        SignalFormStore.ResetForm();
    }

    private int GetContainerTotalRenders()
    {
        return containerSectionRenders + containerFirstNameRenders + containerLastNameRenders + 
               containerEmailRenders + containerProgressRenders + containerValidationRenders;
    }

    private int GetSignalTotalRenders()
    {
        return signalSectionRenders + signalFirstNameRenders + signalLastNameRenders + 
               signalEmailRenders + signalProgressRenders + signalValidationRenders;
    }

    private int GetPerformanceImprovement()
    {
        var containerTotal = GetContainerTotalRenders();
        var signalTotal = GetSignalTotalRenders();
        
        if (containerTotal == 0) return 0;
        
        return (int)Math.Round(((double)(containerTotal - signalTotal) / containerTotal) * 100);
    }

    public void Dispose()
    {
        ContainerStateService.OnChange -= OnContainerStateChanged;
    }
}